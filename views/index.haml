!!!
%html
  %head
    %title Karaoke Time!

    %link{rel: "stylesheet", href: "css/application.css"}

    %script{src: "js/jquery-1.11.2.min.js"}
    %script{src: "js/jquery.fastLiveFilter.js"}

    %script{src: "js/cdgmagic_cdgdecoder_lowresource.js"}
    %script{src: "js/cdgmagic_cdgplayer.js"}

    :javascript

      function init()
      {
          // Initialize the CDG player
          CDG_Player_init("cdg_audio", "cdg_canvas", "cdg_border", "cdg_status");

          // Setup the filter-as-you-type search plugin
          $('#search-field').fastLiveFilter('#search-list', {callback: function(total) { $("#total").text(total); }});

          // The previously clicked song
          last_playing = null;

          // Click a song
          $('#search-list li').click(function() { 
            var elem = $(this);

            // Un-highlight the previously playing song
            if (last_playing !== null)
              last_playing.removeClass("playing");

            // Highlight the currently playing song
            elem.addClass("playing");
            last_playing = elem;

            // Load up the CDG/MP3 in the player
            play_song(elem.data("basename"));

            // Update the song title
            $("#song-title").text(elem.text());
          });

          var search_field = $('#search-field');

          $('body').keydown(function(e) {
            if (!search_field.is(":focus")) {
              search_field.focus();
            }
          });

          selected = null;

          function results() {
            return $("#search-list li:visible");
          }

          function select_next() {
            if (selected && selected.is(":visible")) {
              var n = selected.next(":visible");
              if (n.length && n.length > 0) {
                selected.removeClass("selected");
                n.addClass("selected");
                selected = n;
              }
            } else {
              selected = results().first();
              selected.addClass("selected");
            }
          }

          function select_prev() {
            if (selected && selected.is(":visible")) {
              var n = selected.prev(":visible");
              if (n.length && n.length > 0) {
                selected.removeClass("selected");
                n.addClass("selected");
                selected = n;
              }
            } else {
              selected = results().first();
              selected.addClass("selected");
            }
          }

          search_field.keydown(function(e) {
            // console.log(e, event.keyIdentifier);

            // arrow:
            // 
            switch (event.keyIdentifier) {
              case "Down":
                e.preventDefault();
                console.log("down");
                select_next();
                break;
              case "Up":
                e.preventDefault();
                console.log("up");
                select_prev();
                break;
              case "Enter":
                e.preventDefault();
                console.log("enter");
                if (selected) {
                  selected.click();
                  selected = null;
                }
                break;
              case "U+001B":
                // ESC
                e.preventDefault();
                console.log("esc");
                search_field.val('');
                break;
              default:
                return; // Quit when this doesn't handle the key event.
            }

          });


      };
      

  %body{onload: "init()"}

    .left-column
      / Video player
      #cdg_border
        %canvas#cdg_canvas{width: 288, height: 192}
          Sorry, your browser doesn't support HTML5 canvas. Please upgrade to a recent version of Chrome for Firefox.

      / Audio player
      %audio#cdg_audio
        Sorry, your browser doesn't support HTML5 audio. Please upgrade to a recent version of Chrome for Firefox.

      / Status bar (information about loading the graphics)
      #cdg_status

      / Title of the currently playing song
      #song-title

    .right-column
      %input#search-field

      %span#total
      songs

      %ul#search-list{style: "overflow: auto; height: 600px;"}
        / All the songs
        - @songs.each do |song|
          %li{"data-basename" => song.basename}
            = song.name
